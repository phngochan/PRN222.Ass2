@page
@model PRN222.Ass2.EVDealerSys.Pages.Report.InventoryAllModel
@{
    ViewData["Title"] = "Tồn Kho Theo Đại Lý";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-warehouse text-info"></i> Tồn Kho Theo Đại Lý</h2>
            <p class="text-muted">Theo dõi tình trạng tồn kho và số lượng đã bán</p>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-filter"></i> Bộ Lọc
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Từ ngày (bán hàng)</label>
                    <input type="date" class="form-control" asp-for="FromDate" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Đến ngày (bán hàng)</label>
                    <input type="date" class="form-control" asp-for="ToDate" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Model</label>
                    <select class="form-select" asp-for="FilterModel">
                        <option value="">Tất cả</option>
                        @foreach (var m in Model.AvailableModels)
                        {
                            <option value="@m">@m</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Màu sắc</label>
                    <select class="form-select" asp-for="FilterColor">
                        <option value="">Tất cả</option>
                        @foreach (var c in Model.AvailableColors)
                        {
                            <option value="@c">@c</option>
                        }
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search"></i> Tìm
                    </button>
                    <a asp-page="./InventoryAll" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> Reset
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">Tổng Tồn Kho</h5>
                    <h2>@Model.TotalQuantity xe</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Đã Bán (Kỳ)</h5>
                    <h2>@Model.TotalSold xe</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">Tỷ Lệ Xoay Vòng</h5>
                    <h2>
                        @{
                            var turnoverRate = Model.TotalQuantity > 0 ? ((decimal)Model.TotalSold / (Model.TotalQuantity + Model.TotalSold) * 100) : 0;
                        }
                        @turnoverRate.ToString("F1")%
                    </h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="fas fa-table"></i> Chi Tiết Tồn Kho</span>
            <button onclick="exportToExcel()" class="btn btn-sm btn-success">
                <i class="fas fa-file-excel"></i> Xuất Excel
            </button>
        </div>
        <div class="card-body">
            @if (Model.ReportData.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="inventoryTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Đại Lý</th>
                                <th>Model</th>
                                <th>Màu Sắc</th>
                                <th>Phiên Bản</th>
                                <th class="text-end">Tồn Kho</th>
                                <th class="text-end">Đã Bán (Kỳ)</th>
                                <th class="text-center">Trạng Thái</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in Model.ReportData.OrderBy(r => r.Dealer).ThenBy(r => r.Model))
                            {
                                var stockLevel = row.Quantity switch
                                {
                                    <= 0 => "danger",
                                    <= 5 => "warning",
                                    _ => "success"
                                };

                                var stockText = row.Quantity switch
                                {
                                    <= 0 => "Hết hàng",
                                    <= 5 => "Sắp hết",
                                    _ => "Còn hàng"
                                };

                                <tr>
                                    <td><strong>@row.Dealer</strong></td>
                                    <td>@row.Model</td>
                                    <td>
                                        <span class="badge bg-secondary">@row.Color</span>
                                    </td>
                                    <td>@row.Version</td>
                                    <td class="text-end">
                                        <span class="badge bg-@stockLevel">@row.Quantity</span>
                                    </td>
                                    <td class="text-end">@row.Sold</td>
                                    <td class="text-center">
                                        <span class="badge bg-@stockLevel">
                                            <i class="fas fa-@(row.Quantity <= 0 ? "times-circle" : row.Quantity <= 5 ? "exclamation-triangle" : "check-circle")"></i>
                                            @stockText
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-secondary fw-bold">
                            <tr>
                                <td colspan="4">TỔNG CỘNG</td>
                                <td class="text-end">@Model.TotalQuantity</td>
                                <td class="text-end">@Model.TotalSold</td>
                                <td class="text-center">-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Chart -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <canvas id="inventoryByDealerChart"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="soldVsStockChart"></canvas>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Không có dữ liệu tồn kho.
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        function exportToExcel() {
            const table = document.getElementById('inventoryTable');
            const wb = XLSX.utils.table_to_book(table, { sheet: "Tồn Kho" });
            XLSX.writeFile(wb, 'TonKho_' + new Date().toISOString().slice(0, 10) + '.xlsx');
        }

        @if (Model.ReportData.Any())
        {
            var dealerGroups = Model.ReportData.GroupBy(r => r.Dealer)
                .Select(g => new { Dealer = g.Key, Quantity = g.Sum(x => x.Quantity), Sold = g.Sum(x => x.Sold) })
                .ToList();

            <text>
            // Chart 1: Inventory by Dealer
            const ctx1 = document.getElementById('inventoryByDealerChart');
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: [@Html.Raw(string.Join(",", dealerGroups.Select(d => $"'{d.Dealer}'")))],
                    datasets: [{
                        label: 'Tồn kho',
                        data: [@string.Join(",", dealerGroups.Select(d => d.Quantity))],
                        backgroundColor: '#36A2EB'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tồn Kho Theo Đại Lý'
                        }
                    }
                }
            });

            // Chart 2: Sold vs Stock
            const ctx2 = document.getElementById('soldVsStockChart');
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: [@Html.Raw(string.Join(",", dealerGroups.Select(d => $"'{d.Dealer}'")))],
                    datasets: [
                        {
                            label: 'Tồn kho',
                            data: [@string.Join(",", dealerGroups.Select(d => d.Quantity))],
                            backgroundColor: '#36A2EB'
                        },
                        {
                            label: 'Đã bán',
                            data: [@string.Join(",", dealerGroups.Select(d => d.Sold))],
                            backgroundColor: '#4BC0C0'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'So Sánh Tồn Kho & Đã Bán'
                        }
                    }
                }
            });
            </text>
        }
    </script>
}
